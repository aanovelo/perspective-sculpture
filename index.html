<!DOCTYPE html>
<html>

<head>
  <script type="x-shader/x-vertex" id="vshader">
      attribute vec4 aPosition;
      attribute vec4 aNormal;   // variable for normal vector at each vertex

      uniform mat4 uModelMatrix;                // Model Matrix
      uniform mat4 uViewMatrix;                 // View Matrix
      uniform mat4 uProjectionMatrix;           // Projection Matrix

      uniform mat4 uNormalMatrix;               // Normal Matrix

      uniform vec4 uMaterialDiffuseColor;       // Kd
      uniform vec4 uLightDiffuseColor;          // Ld

      uniform vec4 uLightDirectionVector;       // l

      varying vec4 vDiffuseColor;

      varying vec4 vPosition; // Pass position to fragment shader
      varying vec4 vNormal;

      void main() {

        gl_Position = uProjectionMatrix * uViewMatrix * uModelMatrix * aPosition;

        // Get corrected normal vector from transformation
        vec4 corrected_aNormal = uNormalMatrix * aNormal;

        // Get normalized normal and light vector
            vec4 normalized_aNormalVector = normalize(corrected_aNormal);
            vec4 normalized_uLightDirectionVector = normalize(uLightDirectionVector);

        // Get lambertCooeficient = (-l . n)
            float lambertCoefficient = max(dot(-normalized_uLightDirectionVector,normalized_aNormalVector),0.0);

        // Fd = Ld * Kd * (n dot -l)
            vec4 diffuseColor =  uMaterialDiffuseColor * uLightDiffuseColor * lambertCoefficient;

        vDiffuseColor = vec4(diffuseColor.r, diffuseColor.g, diffuseColor.b, 1.0);

        vPosition = uModelMatrix * aPosition; // Transform position to world space
        vNormal = uNormalMatrix * aNormal; // Transform normal to world space
      }
    </script>

  <script type="x-shader/x-fragment" id="fshader">
      precision highp float;
      varying vec4 vDiffuseColor;

      varying vec4 vPosition;
      varying vec4 vNormal;

      uniform vec4 uMaterialDiffuseColor;
      uniform vec4 uLightDiffuseColor;
      uniform vec4 uLightDirectionVector;

      // Simple noise function
      float random(vec2 st) {
          return fract(sin(dot(st.xy, vec2(12.9898, 78.233))) * 43758.5453123);
      }

      float noise(vec2 st) {
          vec2 i = floor(st);
          vec2 f = fract(st);

          float a = random(i);
          float b = random(i + vec2(1.0, 0.0));
          float c = random(i + vec2(0.0, 1.0));
          float d = random(i + vec2(1.0, 1.0));

          vec2 u = f * f * (3.0 - 2.0 * f);

          return mix(a, b, u.x) + (c - a) * u.y * (1.0 - u.x) + (d - b) * u.x * u.y;
      }


      void main() {
        // Normalize normal and light direction
        vec3 normal = normalize(vNormal.xyz);
        vec3 lightDir = normalize(-uLightDirectionVector.xyz);

        // Lambertian reflection
        float lambertian = max(dot(normal, lightDir), 0.0);

        // Generate grainy texture using noise
        vec2 noiseCoord = vPosition.xy * 10.0; // Scale noise coordinates
        float grain = noise(noiseCoord);

        // Combine diffuse color with grainy texture
        vec4 diffuseColor = uMaterialDiffuseColor * uLightDiffuseColor * lambertian;
        diffuseColor.rgb += grain * 0.2; // Add grain effect

        gl_FragColor = vec4(diffuseColor.rgb, 1.0);
        // gl_FragColor = vDiffuseColor;
      }
    </script>

  <!-- Import external javascript file -->
  <!-- Helper javascript methods for initializing webgl -->
  <script src="./lib/webgl-init.js"></script>
  <script src="./lib/webgl-utils.js"></script>
  <script src="./lib/webgl-debug.js"></script>
  <script src="./lib/gl-matrix-min.js"></script>

  <!-- Link the external Javascript file -->
  <script src="main.js" defer></script>
</head>

<body onload="main()" style="margin: 0;">
  <canvas id="main_canvas" style="display: block;"></canvas>
</body>

</html>
